#!/usr/bin/env python3

"""
Rudder test framework

Usage:
    rtf platform list
    rtf platform status <platform>
    rtf platform setup <platform> [--fail-early] [<key>=<value> ...] [<version>] [plugins=<plugins>]
    rtf platform destroy <platform>
    rtf platform share <platform>
    rtf platform export <platform> [--ova]
    rtf platform shutdown <platform>
    rtf platform snapshot <platform> [<snapshot_name>]
    rtf platform rollback <platform> [<snapshot_name>]
    rtf platform delete-snap <platform> [<snapshot_name>]
    rtf platform update-rudder <platform> [--fail-early] [<version>]
    rtf platform update-os <platform> <version>
    rtf platform dump <platform>
    rtf host list <platform>
    rtf host update-rudder <host> <version>
    rtf host update-os <host> <version>

Options:
    --ova                  Export in ova format (the platform status is not kept)
    --no-finally           Do not run tests tagged FINALLY in the scenario, to avoid coming back to initial state
    --stop                 Stop test on first error
    --filter=...           Only run provided test list from scenario
    --format=<format>      Output format to use (progress, documentation, html or json) [Default: documentation]
    --create-scenario      Generate a sample scenario file to use this test independantly
    --technique=...        Run the technique scenario on the given technique (instead of all technique found)
    --start=<test number>  Run and start the scenario from a given test.
    --cfengine-version=... Define the version of cfengine used to execute the ncf_tests, like 3.10 3.12 rudder-4.3 rudder-latest or ci/rudder-3.2.1
    --destroy-on-error     Destroy the platform if an error is encountered in the run process (scenarii only)
    --fail-early           Stop platform setup on first error

Commands
    All *platform* command are related to platform management. A platform is described is the platforms directory and
    consists of one or more VM in the same network with zero or one rudder component installed.

    All *host* commands are related to a single host within a given platform.

    All *scenario* commands are related to test scenarii. A scenario consists of many successive call to single tests and
    is described in the scenario directory.

    All *test* commands are related to single tests. A test is a serverspec file that calls a command an tests its
    outcome. A test can be used in many different scenarii.

    rtf platform list
        List all available platforms.

    rtf platform status <platform>
        Display current status of given platform.

    rtf platform setup <platform> [<key>=<value> ...] [<version>] [plugins=<plugins>]
        Create and run the given platform's VMs if they are not already up and running.
        Any value from the platform file can be overrided using a key=value parameter.
        The installed Rudder version can be overrider using a single version parameter.
        Pass plugins=all to install all available plugins.
        You must have $DOWNLOAD_USER and $DOWNLOAD_PASSWORD configured in Vagrantfile to install private plugins).

    rtf platform destroy <platform>
        Destroy all VMs in a given platform.

    rtf platform share <platform>
        Share the platform using Hashicorp's atlas. You need an atlas account to do this.

    rtf platform export <platform> [--ova]
        Export the platform in tgz or on ova.

        The tgz form contrains a script to prepare and run th platform on a new machine.
        It must be used on linux with vagrant and on the same major version of virtualbox.

        The ova form export independant VMs archives that can be (theoretically) used on
        any virtualization product. Be careful, this form destroys the original platform.

    rtf platform shutdown <platform>
        Shutdown all VMs without destroying them.

    rtf platform snapshot <platform>
        Snapshots all VMs.

    rtf platform rollback <platform>
        Rollback all VMs to teh last snapshot (in the right order to keep Rudder working).

    rtf platform update-rudder <platform> <version>
        Upgrade Rudder on all machines of the platform.

    rtf platform update-os <platform> <version>
        Upgrade the OS on all machines of the platform.

    rtf host list <platform>
        List hosts of the platform.

    rtf host update-rudder <host> <version>
        Upgrade Rudder on a single host of the platform.

    rtf host update-os <host> <version>
        Upgrade the OS on a single host of the platform.

"""

from subprocess import Popen, PIPE
import os
import re
import importlib
import docopt
from lib import Platform, shell

###################
# Utility methods #
###################

def list_platforms():
  """ List available platforms """
  for file in os.listdir("platforms"):
    print(file.replace(".json", ""))

##########################
# Command line interface #
##########################

if __name__ == "__main__":
  args = docopt.docopt(__doc__)
  script_dir = os.path.dirname(os.path.realpath(__file__))
  os.chdir(script_dir)

  if args['platform']:
    if args['list']:
      list_platforms()
    else:
      if args['status']:
        platform = Platform(args['<platform>'])
        platform.status()
      elif args['setup']:
        override = {}
        for kv in args['<key>=<value>']:
          if '=' in kv:
            (key, value) = kv.split('=')
            override[key] = value
          else:
            override['rudder-version'] = kv
        if args['--fail-early']:
          override['extra_line'] = "set -e"
        platform = Platform(args['<platform>'], override)
        platform.setup(args['--fail-early'])
      elif args['shutdown']:
        platform = Platform(args['<platform>'])
        platform.shutdown()
      elif args['snapshot']:
        platform = Platform(args['<platform>'])
        platform.snapshot(args['<snapshot_name>'])
      elif args['rollback']:
        platform = Platform(args['<platform>'])
        platform.rollback(args['<snapshot_name>'])
      elif args['delete-snap']:
        platform = Platform(args['<platform>'])
        platform.snapshot_delete(args['<snapshot_name>'])
      elif args['destroy']:
        platform = Platform(args['<platform>'])
        platform.teardown()
      elif args['share']:
        platform = Platform(args['<platform>'])
        platform.share()
      elif args['export']:
        platform = Platform(args['<platform>'])
        if args['--ova']:
          platform.export_ova()
        else:
          platform.export()
      elif args['update-rudder']:
        override = {'upgrade': 'true'}
        if args['<version>'] is not None:
          override['rudder-version'] = args['<version>']
        if args['--fail-early']:
          override['extra_line'] = "set -e"
        platform = Platform(args['<platform>'], override)
        platform.update_rudder(args['<version>'], args['--fail-early'])
      elif args['update-os']:
        pass
      elif args['dump']:
        platform = Platform(args['<platform>'])
        platform.dump_datastate()
      elif args['dump_mail']:
        platform = Platform(args['<platform>'])
        platform.dump_training_mail()

  elif args['host']:
    pass
